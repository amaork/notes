# AT91SAM9G20 嵌入式Linux快速启动优化

## 一、说明

### 1. 三级跳转启动
ATMEL AT91系列SOC默认提供的是三级跳转启动：

1. 第一级:RomBoot，romboot是SOC上默认提供的它在上电之后一次开始检测外存中是否有引导程序，如果有引导程序则将外存中的引导程序加载到片内的RAM中执行；
2. 第二级：是由RomBoot加载到片内RAM的bootstrap，由于受限于片内RAM的大小，所以bootstrap不能太大尺寸也就不能执行更多复杂的操作，所以bootstrap的作用就是对外设做简单的初始化，然后从外存中加载一个更大的bootlader到到SDRAM中，然后跳转到sdram中执行；
3. 第三级：是由bootstrap加载到SDRAM中的Bootloader，通常是U-boot，u-boot是在内存中执行的，大小不受限制然后就在u-boot中将内核加载到内存中然后引导内核挂载文件系统

### 2.启动流程
一下的顺序是整个系统的启动流程，优化启动速度主要从以下的各个环节考虑

		ROMBoot ---> Bootstrap ---> Bootloader ---> Kernel ---> Application

### 3. 优化设计
AT91SAM9G20的片内RAM为16K，也就说说Bootstrap的尺寸只要在16K大小之内就可以了，16K的程序可以做许多工作了。甚至，可以将bootloader的功能整合到bootstrap中，然后直接由bootstrap直接引导内核，那么系统的启动流程就成为了：

		ROMBoot ---> Bootstrap ---> Kernel ---> Application

这样减少了Bootloader对系统的启动速度有一定的帮助，u-boot的启动初始化了许多外设使启动时间进一步减少。通过测量启动时间，知道ROMboot + Boostrap的启动花费了5秒左右，而其中的3秒是Bootstrap启动时间，内核启动花费了3.5秒左右，以下的优化主要从以下两个方面着手，通过分别缩减Bootstrap和内核的启动。


## 二、Bootstrap优化

Bootstrap的主要工作是初始化SDRAM和主时钟以及必要的外设，调用用户自定义的硬件初始化程序（用户初始化程序，一般用来做在LCD上绘制启动Logo）然后将内核从NAND Flash搬运到SDRAM中，同时设置好内核启动参数然后，跳转到内存中内核的启动位置开始启动内核。优化主要从以下方面着手：

1. 减少内核的尺寸，从而减少从NAND FLASH搬运的内核到SDRAM的时间（这一步和内核的优化是相辅相成的）
2. 去掉不必要的用户初始化

## 三、Kernel启动优化

在Bootstrap中将内核从NAND FLASH 搬运到SDRAM中指定的位置之后，然后就跳转到内存中内核所在的位置开始执行。内核分两种一种是没有压缩的内核（arch/arm/boot/Image），这种内核就直接开始执行，另一种是压缩的内核，需要首先解压缩之后才能执行。这两种内核的利弊情况是：

- 未压缩的内核比较大，大概是压缩内核的2倍大小，这样往内存中搬运的时候搬运的时间就比较长，但内核可以直接启动不需要再解压缩
- 压缩的内核比较小，从NAND FLASH往内存中搬运的比较短，但内核启动前需要解压缩，解压缩的速度应该和CPU的运算能力有关

根据以上的分析情况来看，从NAND FLASH向SDRAM拷贝东西的速度大概是**4M/s**,由于是ARM架构，解压缩内核的速度不是很快，因此就考虑使用未未压缩内核。

然后可以从内核的启动时间上分析，考虑，可以将内核设置为quiet从而节省下大约1秒钟左右的启动时间。对内核的优化：

1. 尽量减小内核的尺寸
2. 使用未压缩内核
3. 将内核的启动模式设置为quiet
4. 在启动参数中预置lpj


