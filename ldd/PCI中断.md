# PCI中断
---

## 概述

- 在传统的PCI总线中，使用INTA#、INTB#、INTC#、INTD#四根信号线向CPU传递中断信号，PCI设备是以共享的方式，来使用这4根中断线的。但在PCIE总线中，则是使用MSI和MSIX消息的方式来向CPU传递中断信号，MSI是PCIE必须支持的，而PCI不必支持。


- MSI和MSIX都是设备向CPU给设备分配的一个特殊地址写一个特定的数据，CPU识别到这个将其解释为中断。MSI中断写的地址和数据都是由CPU分配的。地址有32位和64位之分，写的数据都是16位的，当启用MSI之后，CPU会将MSI地址和MSI数据写入PCI的扩展寄存器中。
 

- MSI和MSIX的区别在于MSI的区别在于MSI最多支持32个中断，并且中断的数目必须是2的幂，申请到的中断号是连续的。（X86系统中目前最多支持1个MSI中断）而MSIX则最多支持2048个中断，中断编号没有MSI中断的相关限制。

- 当使用MSI和MSIX中断的时候，需要将PCI配置寄存器中的MASTER位置位，因为MSI中断其实就是有PCI设备发起的一个DMA写操作，所以需要使设备工作在Master方式下。

- PCIE对中断的支持有两种方式：一种是之前提到的MSI消息的方式，这个是PCIE规范中指明必须实现的，另外一种是虚拟中断线的方式（Virtual Interrupt Wire）。虚拟中断线方式是为了兼容系统中现有的老式PCI使用INTA-D中断线的方式，因为在一个PCIE桥下面可能有PCIE设备也可能有PCI设备，PCIE设备可以使用MSI中断而老式的PCI设备则不能使用。以PEX8112为例这两种中断方式是互斥的，只能使用其中的一种。

## Linux 设备驱动中断

- 在Linux设备驱动中，PCI的中断号保存在struct pci\_dev 的 irq中。irq中保存的中断号是PCI使用INTA-D这种中断线方式中断的中断号，如果要使用MSI则需要先调用pci\_enable\_msi来使能MSI中断，当使能MSI之后会重新分配中断号，重新分配的中断号依然保存在irq中，而之前的那个irq则无效。所以在使用MSI的时候，一定要在request\_irq之前调用pci\_enable\_msi，否则pci\_dev中的irq号是无效的，因为MSI中断和传统的中断是互斥的。


- 当使用传统中断方式在注册中断函数的时候，需要标记为共享中断再注册，使用MSI中断的时候就就不需要这么做了。

